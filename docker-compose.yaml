services:
  abogen:
    build:
      context: .
      dockerfile: abogen/Dockerfile
      args:
        TORCH_INDEX_URL: ${TORCH_INDEX_URL:-https://download.pytorch.org/whl/cu124}
        TORCH_VERSION: ${TORCH_VERSION:-}
    image: abogen:latest
    user: "${ABOGEN_UID:-1000}:${ABOGEN_GID:-1000}"
    ports:
      - "${ABOGEN_PORT:-8808}:8808"
    volumes:
      - ${ABOGEN_DATA:-./data}:/data
    environment:
      ABOGEN_HOST: 0.0.0.0
      ABOGEN_PORT: 8808
      ABOGEN_UPLOAD_ROOT: /data/uploads
      ABOGEN_OUTPUT_ROOT: /data/outputs
      ABOGEN_TEMP_DIR: "${ABOGEN_TEMP_DIR:-/data/cache}"
    # --- GPU support -----------------------------------------------------
    # These settings assume the NVIDIA Container Toolkit is installed.
    # Leave them in place for GPU acceleration; comment out the entire block
    # below if you are deploying to a CPU-only host.
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              # driver: nvidia
              # count: all
    # Runtime flag is only honored by legacy docker-compose (v1) CLI.
    # Uncomment if you're still using it:
    # runtime: nvidia
    restart: unless-stopped
